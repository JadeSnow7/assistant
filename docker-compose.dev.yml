# AI Assistant å¼€å‘ç¯å¢ƒDocker Composeé…ç½®
# ç”¨äºæœ¬åœ°å¼€å‘ï¼ŒåŒ…å«çƒ­é‡è½½å’Œè°ƒè¯•åŠŸèƒ½

version: '3.8'

services:
  # AI Assistantå¼€å‘æœåŠ¡
  ai-assistant-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
      args:
        - USER_ID=${USER_ID:-1000}
        - GROUP_ID=${GROUP_ID:-1000}
    image: ai-assistant:dev
    container_name: ai-assistant-dev
    ports:
      - "8000:8000"   # APIæœåŠ¡ç«¯å£
      - "50051:50051" # gRPCæœåŠ¡ç«¯å£
      - "5678:5678"   # Pythonè°ƒè¯•ç«¯å£
    environment:
      - HOST=0.0.0.0
      - PORT=8000
      - GRPC_PORT=50051
      - LOG_LEVEL=DEBUG
      - DEBUG=true
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    volumes:
      - .:/app                     # æºä»£ç æŒ‚è½½(çƒ­é‡è½½)
      - dev-data:/app/data         # å¼€å‘æ•°æ®
      - dev-logs:/app/logs         # å¼€å‘æ—¥å¿—
      - /app/venv                  # æ’é™¤è™šæ‹Ÿç¯å¢ƒ
      - /app/__pycache__           # æ’é™¤ç¼“å­˜
      - /app/.git                  # æ’é™¤gitç›®å½•
    depends_on:
      - redis-dev
    networks:
      - ai-assistant-dev-network
    restart: unless-stopped
    stdin_open: true
    tty: true
    command: ["server"]

  # Rediså¼€å‘ç¯å¢ƒ
  redis-dev:
    image: redis:7-alpine
    container_name: ai-assistant-redis-dev
    ports:
      - "6380:6379"  # é¿å…ä¸ç”Ÿäº§Rediså†²çª
    volumes:
      - redis-dev-data:/data
    networks:
      - ai-assistant-dev-network
    restart: unless-stopped

  # æµ‹è¯•æ•°æ®åº“
  postgres-test:
    image: postgres:15-alpine
    container_name: ai-assistant-postgres-test
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_DB=ai_assistant_test
      - POSTGRES_USER=test_user
      - POSTGRES_PASSWORD=test_password
    volumes:
      - postgres-test-data:/var/lib/postgresql/data
    networks:
      - ai-assistant-dev-network
    restart: unless-stopped

  # å¼€å‘å·¥å…·å®¹å™¨
  dev-tools:
    build:
      context: .
      dockerfile: Dockerfile.dev-tools
    image: ai-assistant:dev-tools
    container_name: ai-assistant-dev-tools
    volumes:
      - .:/workspace
    working_dir: /workspace
    networks:
      - ai-assistant-dev-network
    profiles:
      - tools
    command: ["sleep", "infinity"]

  # æµ‹è¯•è¿è¡Œå™¨
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.dev
    image: ai-assistant:dev
    container_name: ai-assistant-test-runner
    volumes:
      - .:/app
      - test-reports:/app/test_reports
    environment:
      - PYTHONPATH=/app
      - TEST_MODE=true
    networks:
      - ai-assistant-dev-network
    profiles:
      - test
    command: ["python", "tests/cli/run_cli_tests.py", "--no-health-check"]

  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    build:
      context: .
      dockerfile: Dockerfile.dev-tools
    image: ai-assistant:dev-tools
    container_name: ai-assistant-code-quality
    volumes:
      - .:/workspace
    working_dir: /workspace
    networks:
      - ai-assistant-dev-network
    profiles:
      - quality
    command: |
      sh -c "
        echo 'ğŸ” Running code quality checks...'
        black --check python/ ui/ &&
        isort --check-only python/ ui/ &&
        flake8 python/ ui/ --max-line-length=120 &&
        mypy python/ --ignore-missing-imports &&
        echo 'âœ… All code quality checks passed!'
      "

networks:
  ai-assistant-dev-network:
    driver: bridge

volumes:
  dev-data:
    driver: local
  dev-logs:
    driver: local
  redis-dev-data:
    driver: local
  postgres-test-data:
    driver: local
  test-reports:
    driver: local