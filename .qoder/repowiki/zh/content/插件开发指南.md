
# 插件开发指南

<cite>
**本文档引用的文件**
- [plugin_base.py](file://python/sdk/plugin_base.py)
- [main.py](file://python/plugins/weather/main.py)
- [plugin.json](file://python/plugins/weather/plugin.json)
- [plugin_loader.hpp](file://cpp/include/plugin_loader.hpp)
</cite>

## 目录
1. [插件架构概述](#插件架构概述)
2. [核心基类PluginBase详解](#核心基类pluginbase详解)
3. [插件配置文件规范](#插件配置文件规范)
4. [天气插件实现示例](#天气插件实现示例)
5. [插件生命周期管理](#插件生命周期管理)
6. [调试与异常处理](#调试与异常处理)
7. [线程安全与通信机制](#线程安全与通信机制)
8. [最佳实践建议](#最佳实践建议)
9. [安全沙箱与权限控制](#安全沙箱与权限控制)

## 插件架构概述

```mermaid
graph TD
subgraph "插件系统"
PluginManager[插件管理器]
PluginLoader[插件加载器]
PluginBase[插件基类]
end
subgraph "插件类型"
PythonPlugin[Python插件]
CPPPlugin[C++插件]
end
PluginManager --> PluginLoader
PluginLoader --> PythonPlugin
PluginLoader --> CPPPlugin
PythonPlugin --> PluginBase
CPPPlugin --> IPlugin
```

**图示来源**
- [plugin_loader.hpp](file://cpp/include/plugin_loader.hpp#L0-L54)
- [plugin_base.py](file://python/sdk/plugin_base.py#L0-L64)

## 核心基类PluginBase详解

### 继承PluginBase类

所有Python插件必须继承`PluginBase`抽象基类，该类定义了插件的核心接口和功能。开发者需要实现以下抽象方法：

```mermaid
classDiagram
class PluginBase {
+logger : Logger
+config : Dict[str, Any]
+enabled : bool
+initialized : bool
+last_error : Optional[str]
+stats : Dict[str, Any]
+__init__()
+initialize(config) bool
+execute(command, params) Dict[str, Any]
+get_info() Dict[str, Any]
+cleanup()
+is_healthy() bool
+safe_execute(command, params) Dict[str, Any]
+enable()
+disable()
+get_stats() Dict[str, Any]
+get_status() Dict[str, Any]
+validate_params(params, schema) Dict[str, Any]
}
class WeatherPlugin {
-api_key : Optional[str]
-base_url : str
-units : str
-cache_duration : int
-_cache : Dict[str, Any]
+initialize(config) bool
+execute(command, params) Dict[str, Any]
+get_info() Dict[str, Any]
+cleanup()
+is_healthy() bool
+_get_current_weather(params) Dict[str, Any]
+_get_weather_forecast(params) Dict[str, Any]
+_search_city(params) Dict[str, Any]
+_format_weather_data(data) Dict[str, Any]
+_format_forecast_data(data, days) Dict[str, Any]
+_process_daily_data(date, hourly_data) Dict[str, Any]
+_get_from_cache(key) Optional[Dict[str, Any]]
+_save_to_cache(key, data)
+_test_api_connection() bool
}
WeatherPlugin --|> PluginBase : "继承"
```

**图示来源**
- [plugin_base.py](file://python/sdk/plugin_base.py#L0-L64)
- [main.py](file://python/plugins/weather/main.py#L0-L50)

### 核心方法实现

#### initialize方法
初始化插件实例，接收配置参数并进行必要的设置和验证。

**代码路径**
- [plugin_base.py](file://python/sdk/plugin_base.py#L15-L30)
- [main.py](file://python/plugins/weather/main.py#L50-L80)

#### execute方法
执行插件命令的核心方法，根据不同的命令名称调用相应的处理函数。

**代码路径**
- [plugin_base.py](file://python/sdk/plugin_base.py#L30-L45)
- [main.py](file://python/plugins/weather/main.py#L80-L110)

#### get_info方法
返回插件的元数据信息，包括名称、版本、功能描述等。

**代码路径**
- [plugin_base.py](file://python/sdk/plugin_base.py#L45-L58)
- [main.py](file://python/plugins/weather/main.py#L350-L390)

#### cleanup方法
清理插件占用的资源，如关闭连接、清除缓存等。

**代码路径**
- [plugin_base.py](file://python/sdk/plugin_base.py#L58-L67)
- [main.py](file://python/plugins/weather/main.py#L392-L396)

#### is_healthy方法
健康检查方法，用于检测插件是否处于正常工作状态。

**代码路径**
- [plugin_base.py](file://python/sdk/plugin_base.py#L67-L78)
- [main.py](file://python/plugins/weather/main.py#L400-L404)

## 插件配置文件规范

### plugin.json结构解析

每个插件必须包含一个`plugin.json`配置文件，定义插件的基本信息和运行要求。

```json
{
    "name": "weather_plugin",
    "version": "1.0.0",
    "description": "天气查询插件，支持查询全球城市天气信息",
    "author": "AI Assistant Team",
    "type": "python",
    "entry_point": "main.py",
    "capabilities": [
        "weather_query",
        "weather_forecast",
        "weather_alerts"
    ],
    "dependencies": [
        "requests",
        "json"
    ],
    "config_schema": {
        "type": "object",
        "properties": {
            "api_key": {
                "type": "string",
                "description": "天气API密钥"
            },
            "default_units": {
                "type": "string",
                "enum": ["metric", "imperial"],
                "default": "metric",
                "description": "默认单位制"
            },
            "cache_duration": {
                "type": "integer",
                "default": 300,
                "description": "缓存时间(秒)"
            }
        },
        "required": ["api_key"]
    },
    "permissions": [
        "network_access",
        "cache_access"
    ],
    "enabled": true
}
```

### 配置字段说明

| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| name | string | 是 | 插件唯一标识名称 |
| version | string | 是 | 插件版本号，遵循语义化版本规范 |
| description | string | 是 | 插件功能描述 |
| author | string | 是 | 插件作者信息 |
| type | string | 是 | 插件类型(python/cpp) |
| entry_point | string | 是 | 插件入口文件路径 |
| capabilities | array | 否 | 插件能力列表 |
| dependencies | array | 否 | 插件依赖的第三方库 |
| config_schema | object | 是 | 插件配置参数架构 |
| permissions | array | 是 | 插件所需权限列表 |
| enabled | boolean | 是 | 插件初始启用状态 |

**代码路径**
- [plugin.json](file://python/plugins/weather/plugin.json#L0-L42)

## 天气插件实现示例

### 完整实现流程

```mermaid
sequenceDiagram
participant 用户 as 用户
participant 系统 as 系统
participant 插件管理器 as 插件管理器
participant 天气插件 as 天气插件
participant API服务 as 天气API服务
用户->>系统 : 请求天气信息
系统->>插件管理器 : 查询可用插件
插件管理器-->>系统 : 返回天气插件
系统->>天气插件 : 调用execute方法
天气插件->>天气插件 : 检查缓存
alt 缓存命中
天气插件-->>系统 : 返回缓存数据
else 缓存未命中
天气插件->>API服务 : 调用API获取数据
API服务-->>天气插件 : 返回原始数据
天气插件->>天气插件 : 格式化数据
天气插件->>天气插件 : 存储到缓存
天气插件-->>系统 : 返回格式化数据
end
系统-->>用户 : 显示天气信息
```

**图示来源**
- [main.py](file://python/plugins/weather/main.py#L80-L110)
- [main.py](file://python/plugins/weather/main.py#L110-L200)

### 命令路由实现

天气插件实现了三个主要命令：获取当前天气、获取天气预报和搜索城市。

```mermaid
flowchart TD
Start([开始]) --> Execute["execute(command, params)"]
Execute --> CommandCheck{"command == 'get_weather'?"}
CommandCheck --> |是| GetCurrentWeather["_get_current_weather(params)"]
CommandCheck --> |否| ForecastCheck{"command == 'get_forecast'?"}
ForecastCheck --> |是| GetForecast["_get_weather_forecast(params)"]
ForecastCheck --> |否| SearchCheck{"command == 'search_city'?"}
SearchCheck --> |是| SearchCity["_search_city(params)"]
SearchCheck --> |否| UnknownCommand["返回未知命令错误"]
GetCurrentWeather --> FormatData["格式化天气数据"]
GetForecast --> FormatForecast["格式化预报数据"]
SearchCity --> CallGeoAPI["调用地理编码API"]
FormatData --> CheckCache["检查缓存"]
FormatForecast --> CheckCache
CheckCache --> CacheHit{"缓存命中?"}
CacheHit --> |是| ReturnFromCache["返回缓存数据"]
CacheHit --> |否| CallWeatherAPI["调用天气API"]
CallWeatherAPI --> ProcessResponse["处理API响应"]
ProcessResponse --> UpdateCache["更新缓存"]
UpdateCache --> ReturnResult["返回结果"]
ReturnFromCache --> ReturnResult
ReturnResult --> End([结束])
```

**图示来源**
- [main.py](file://python/plugins/weather/main.py#L80-L110)
- [main.py](file://python/plugins/weather/main.py#L110-L200)

## 插件生命周期管理

### 生命周期阶段

```mermaid
stateDiagram-v2
[*] --> 未加载
未加载 --> 已加载 : 加载插件
已加载 --> 初始化中 : 调用initialize
初始化中 --> 已初始化 : 初始化成功
初始化中 --> 初始化失败 : 初始化失败
已初始化 --> 已启用 : 调用enable
已启用 --> 已禁用 : 调用disable
已禁用 --> 已启用 : 调用enable
已启用 --> 执行中 : 调用execute
执行中 --> 已启用 : 执行完成
已启用 --> 清理中 : 调用cleanup
清理中 --> 已卸载 : 卸载插件
已卸载 --> [*]
```

**图示来源**
- [plugin_base.py](file://python/sdk/plugin_base.py#L15-L78)
- [plugin_loader.hpp](file://cpp/include/plugin_loader.hpp#L47-L97)

### 状态转换API

插件管理系统提供了完整的生命周期管理API：

```mermaid
classDiagram
class PluginManager {
+scan_plugins(plugin_dir) void
+load_plugin(plugin_path) bool
+unload_plugin(plugin_name) bool
+enable_plugin(plugin_name) bool
+disable_plugin(plugin_name) bool
+reload_plugin(plugin_name) bool
+execute_plugin(plugin_name, command, params) string
+get_all_plugins() List[PluginInfo]
+get_enabled_plugins() List[string]
+has_plugin(plugin_name) bool
}
class PluginLoader {
+scan_plugins(plugin_dir) void
+load_cpp_plugin(plugin_path) bool
+load_python_plugin(plugin_path) bool
+unload_plugin(plugin_name) bool
+enable_plugin(plugin_name) bool
+disable_plugin(plugin_name) bool
+execute_plugin(plugin_name, command, params) string
+get_all_plugins() List[PluginInfo]
+get_enabled_plugins() List[string]
}
PluginManager --> PluginLoader : "委托"
```

**代码路径**
- [plugin_loader.hpp](file://cpp/include/plugin_loader.hpp#L47-L97)
- [api_router.py](file://python/agent/api_router.py#L123-L162)

## 调试与异常处理

### 异常类型体系

```mermaid
classDiagram
class Exception {
+__init__(message)
}
class PluginError {
+message : str
+error_code : str
+to_dict() Dict[str, Any]
}
class PluginTimeout {
+timeout_seconds : float
}
class PluginConfigError {
}
class PluginPermissionError {
+permission : str
}
PluginError --|> Exception
PluginTimeout --|> PluginError
PluginConfigError --|> PluginError
PluginPermissionError --|> PluginError
```

**图示来源**
- [plugin_base.py](file://python/sdk/plugin_base.py#L215-L250)

### 错误处理策略

```mermaid
flowchart TD
Start([开始]) --> SafeExecute["safe_execute(command, params)"]
SafeExecute --> CheckEnabled{"插件已启用?"}
CheckEnabled --> |否| ReturnDisabled["返回\"插件未启用\""]
CheckEnabled --> |是| CheckInitialized{"插件已初始化?"}
CheckInitialized --> |否| ReturnNotInit["返回\"插件未初始化\""]
CheckInitialized --> |是| TryExecute["尝试执行execute"]
TryExecute --> ExecuteSuccess{"执行成功?"}
ExecuteSuccess --> |是| UpdateStats["更新统计信息"]
ExecuteSuccess --> |否| HandleException["处理异常"]
HandleException --> LogError["记录错误日志"]
HandleException --> UpdateFailStats["更新失败统计"]
UpdateStats --> ReturnSuccess["返回成功结果"]
UpdateFailStats --> ReturnError["返回错误结果"]
ReturnSuccess --> End([结束])
ReturnError --> End
```

**代码路径**
- [plugin_base.py](file://python/sdk/plugin_base.py#L80-L149)

## 线程安全与通信机制

### 并发控制

```mermaid
classDiagram
class PluginBase {
+stats : Dict[str, Any]
+_lock : asyncio.Lock
+safe_execute(command, params) Dict[str, Any]
+get_stats() Dict[str, Any]
+get_status() Dict[str, Any]
}
class WeatherPlugin {
+_cache : Dict[str, Any]
+_cache_lock : asyncio.Lock
+_get_from_cache(key) Optional[Dict[str, Any]]
+_save_to_cache(key, data)
}
WeatherPlugin --|> PluginBase
```

**代码路径**
- [plugin_base.py](file://python/sdk/plugin_base.py#L8-L20)
- [main.py](file://python/plugins/weather/main.py#L5-L20)

### 插件间通信

```mermaid
graph TD
subgraph "消息总线"
EventBus[事件总线]
end
subgraph "插件A"
PluginA[插件A]
PluginA --> EventBus : 发布事件
end
subgraph "插件B"
PluginB[插件B]
EventBus --> PluginB : 订阅事件
end
subgraph "插件C"
PluginC[插件C]
EventBus --> PluginC : 订阅事件
end
EventBus < --> PluginManager : 事件分发
PluginManager --> Orchestrator : 状态同步
```

**代码路径**
- [orchestrator.py](file://python/agent/orchestrator.py#L278-L316)

## 最佳实践建议

### 性能优化

```mermaid
flowchart LR
    A[避免阻塞主线程] --> B[使用异步IO]
    B --> C[合理使用缓存]
